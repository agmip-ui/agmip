function make_default_when_undefined(e,a){return"undefined"==typeof e?a:e}function build_current_data(e){var a,t,n,r,o,d,i,s,l,_="N/A";vm.current_data([]);for(var c=0;c<e.length;c++)a=make_default_when_undefined(e[c].eid,_),t=make_default_when_undefined(e[c].crid,_),n=make_default_when_undefined(e[c].pdate,_),r=make_default_when_undefined(e[c].soil,_),o=make_default_when_undefined(e[c].institution,_),d=make_default_when_undefined(e[c].country,_),i=make_default_when_undefined(e[c].exname,_),s=make_default_when_undefined(e[c].rating,"unrated"),l=-1===vm.findIndex(a,vm.saved_data())?!1:!0,vm.current_data.push(new experiment(a,t,n,r,o,d,i,s,l));vm.showHideCurrentDataTable()}function enable_disable_download_button(){var e=!1;$(".db_type_filter").each(function(a,t){return $(t).prop("checked")?($("#download_data").prop("disabled",!1),e=!0,!1):void 0}),e===!1&&$("#download_data").prop("disabled",!0)}function obtain_initial_map_population(){$("#spinner").modal("show"),options={type:"GET",url:api_url+"/cache/location",cache:!0,dataType:"json"},$.ajax(options).done(function(e){place_markers_and_clusters_on_map(e)}).fail(function(e,a){$("#error_message").text("Error: Failed To Populate Map: "+a),$("#alertModal").modal("show")}).always(function(){$("#spinner").modal("hide")})}function obtain_specific_crop_map_population(e){$("#spinner").modal("show"),"none"==e&&(e=""),options={type:"GET",url:api_url+"/cache/location/"+e,cache:!0,dataType:"json"},$.ajax(options).done(function(e){place_markers_and_clusters_on_map(e)}).fail(function(){$("#error_message").text("Error: Search Operation Has Failed"),$("#alertModal").modal("show")}).always(function(){$("#spinner").modal("hide")})}function retrieve_data(e,a,t){if(max_eids=1500,t>max_eids)$("#error_message").html("Data Size Is Too Large. More Than Data Points "+max_eids+" Selected. <br>Please Specify Data By Using Filter Or By Zooming In."),$("#alertModal").modal("show");else{$("#spinner").modal("show");var n={};n.geohashes=a,"none"!=e&&(n.crop=crop.type),n=JSON.stringify(n),options={type:"POST",url:api_url+"/query/geohash",data:n,dataType:"json",contentType:"application/json"},$.ajax(options).done(function(e){build_current_data(e)}).fail(function(){$("#error_message").text("Error: Failed to Obtain Data"),$("#alertModal").modal("show")}).always(function(){$("#spinner").modal("hide"),vm.selectedAllChecked(!1)})}}function retrieve_database(e,a){$("#spinner").modal("show"),a=JSON.stringify(a),e=JSON.stringify(e),options={type:"POST",url:api_url,data:{database_types:e,eids:a},cache:!0,dataType:"json"},$.ajax(options).done(function(e){$("#map").trigger("prompt_user_for_download",e)}).fail(function(){$("#error_message").text("Error: Failed to Download Database"),$("#alertModal").modal("show")}).always(function(){$("#spinner").modal("hide")})}function render_map_initially(){var e=L.tileLayer("http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpeg",{attribution:"",subdomains:"1234"}),a=L.map("map",{maxZoom:13,minZoom:2,maxBounds:[[-90,-180],[90,180]]}).setView([15,0],1);return e.addTo(a),a.on("zoomend",function(){map.closePopup()}),a}function raise_marker_popup(e,a,t,n,r){n.setLatLng(e).openOn(r).setContent("<b style='color:#bb382b;'>Geohash Point</b> <br><button type='button' data-geohashes='"+JSON.stringify([a])+"' data-eid_count='"+t+"'class='btn btn-primary borRad obtain_data_from_cluster_or_marker' >Obtain Data</button> <br>has "+t+" experiments")}function create_markers_for_map(e){var a=L.popup({offset:L.point(0,-32)});geojsonLayer=L.geoJson(e,{pointToLayer:function(e,t){return L.marker(t,{geohash:e.properties.geohash,count:e.properties.count}).on("contextmenu",function(e){raise_marker_popup(e.latlng,this.options.geohash,this.options.count,a,map)})}}),markerLayer&&map.removeLayer(markerLayer)}function raise_cluster_popup(e,a,t,n,r){n.setLatLng(e).openOn(r).setContent("<b class='blueTxt'>Cluster of Geohashes</b><br><button type='button' data-geohashes='"+JSON.stringify(a)+"' data-eid_count='"+t+"' class='btn btn-primary borRad obtain_data_from_cluster_or_marker'>Obtain Data</button> <br> has "+t+" experiments")}function create_clusters_for_map(){markerLayer=new L.MarkerClusterGroup,markerLayer.addLayer(geojsonLayer);var e=L.popup({offset:L.point(0,-10)});markerLayer.on("clustercontextmenu",function(a){for(var t=a.layer.getAllChildMarkers(),n=[],r=0,o=0;o<t.length;o++)n.push(t[o].options.geohash),r+=parseFloat(t[o].options.count);raise_cluster_popup(a.latlng,n,r,e,map)})}function place_markers_and_clusters_on_map(e){create_markers_for_map(e),create_clusters_for_map(),map.addLayer(markerLayer)}function experiment(e,a,t,n,r,o,d,i,s){var l=this;l.eid=e,l.crid=a,l.pdate=t,l.soil=n,l.institution=r,l.country=o,l.exname=d,l.rating=i,l.checked=ko.observable(s)}function all_experiments(){var e=this;e.current_data=ko.observableArray([]),e.saved_data=ko.observableArray([]),e.selected_all_checked=ko.observable(!1),e.updateCheckMark=function(a,t){e.current_data()[a].checked(t)},e.toggleCheckMark=function(a){e.current_data()[a].checked(!e.current_data()[a].checked())},e.selectAllCheckMarks=function(){for(var a=0;a<e.current_data().length;a++)current_data_eid=e.current_data()[a].eid,index=e.findIndex(current_data_eid,e.saved_data()),e.updateCheckMark(a,!0),-1===index&&e.saved_data.push(e.current_data()[a])},e.deselectAndRemoveSubsetCheckMarks=function(){for(i=0;i<e.current_data().length;i++)e.updateCheckMark(i,!1),current_data_eid=e.current_data()[i].eid,saved_data_index=e.findIndex(current_data_eid,e.saved_data()),-1!==saved_data_index&&e.saved_data.removeValueAtIndex(saved_data_index)},e.deselectAllCheckMarks=function(){for(i=0;i<e.current_data().length;i++)e.updateCheckMark(i,!1)},e.removeAllCurrentData=function(){$("#clear_current_data").css("display","none"),$("#current_data_number").hide(),$("#current_data").hide(),e.current_data([]),e.showHideCurrentDataTable()},e.clearSavedData=function(){e.saved_data([]),e.deselectAllCheckMarks(),e.showHideSavedDataTable()},e.selectAllCurrentDataClicked=function(){return e.selected_all_checked()?(e.selected_all_checked(!1),e.deselectAndRemoveSubsetCheckMarks(),e.showHideSavedDataTable()):(e.selected_all_checked(!0),e.selectAllCheckMarks(),e.showHideSavedDataTable(),$("html, body").animate({scrollTop:$("#saved_data_container").offset().top},1200)),!0},e.selectorClicked=function(a){return saved_data_index=e.findIndex(a.eid,e.saved_data()),current_data_index=e.findIndex(a.eid,e.current_data()),e.toggleCheckMark(current_data_index),-1===saved_data_index?(datum=e.current_data()[current_data_index],e.saved_data.push(datum)):e.saved_data.removeValueAtIndex(saved_data_index),e.showHideSavedDataTable(),!0},e.removerClicked=function(a){return saved_data_index=e.findIndex(a.eid,e.saved_data()),e.saved_data.removeValueAtIndex(saved_data_index),current_data_index=e.findIndex(a.eid,e.current_data()),e.toggleCheckMark(current_data_index),e.showHideSavedDataTable(),!0},e.showHideCurrentDataTable=function(){if(e.current_data().length>0){$("#current_data").show(),$("#clear_current_data").show(),$("#current_data_number").show(),$("#current_data_number").find("b").text(e.current_data().length);var a=$("a[data-target='#current_data_container']");a.hasClass("collapsed")&&(a.removeClass("collapsed"),$("#current_data_container").collapse("toggle")),$("html, body").animate({scrollTop:$("#current_data_container").offset().top},1200)}else e.selected_all_checked(!1)},e.showHideSavedDataTable=function(){if(e.saved_data().length>0){$("#saved_data").show(),$(".saved_data_button").show();var a=$("a[data-target='#saved_data_container']");a.hasClass("collapsed")&&(a.removeClass("collapsed"),$("#saved_data_container").collapse("toggle")),$("#saved_data_number").show(),$("#saved_data_number").text(e.saved_data().length)}else $("#saved_data").hide(),$(".saved_data_button").hide(),$("#saved_data_number").hide(),e.selected_all_checked(!1)},e.findIndex=function(e,a){for(var t=0;t<a.length;t++)if(e===a[t].eid)return t;return-1},e.extractEids=function(e){var a=[];for(i=0;i<e.length;i++)a.push(e[i].eid);return a}}$("#obtain_data").click(function(){var e=$("#crop_filter").val(),a=[],t=map.getBounds(),n=0;markerLayer.eachLayer(function(e){t.contains(e.getLatLng())&&(a.push(e.options.geohash),n+=parseFloat(e.options.count))}),retrieve_data(e,a,n)}),$("#map").on("click",".obtain_data_from_cluster_or_marker",function(){var e=$(this).data("geohashes"),a=$(this).data("eid_count");map.closePopup(),retrieve_data("none",e,a)}),$("#map").on("place_markers_and_clusters_on_map",function(e,a){a.location_data.length>0&&(markers=[],place_markers_and_clusters_on_map(a.location_data))}),$("#map").on("build_current_data",function(e,a){build_current_data(a.data)}),$("#map").on("prompt_user_for_download",function(e,a){window.open(a.url,"","width=200,height=100")}),$("#apply_filter").click(function(){map.closePopup();var e=$("#crop_filter").val();obtain_specific_crop_map_population(e)}),$("#download_data").click(function(){if(vm.saved_data().length>0){var e=[],a=$(".db_type_filter"),t=[];$(a).each(function(t){$(a[t]).prop("checked")&&e.push($(a[t]).val())}),t=vm.extractEids(vm.saved_data()),retrieve_database(e,t)}}),$(".db_type_filter").click(function(){enable_disable_download_button()}),$("#raise_up_download_modal").click(function(){$(".db_type_filter").each(function(e,a){$(a).prop("checked",!1),$("#download_data").prop("disabled",!0)})}),$(".modal").on("show.bs.modal",function(){$("body").css("overflow-y","hidden"),$(this).css("overflow-y","hidden")}),$(".modal").on("hide.bs.modal",function(){$("body").css("overflow-y","auto"),$(this).css("overflow-y","auto")});var api_url="http://api.agmip.org/cropsitedb/1",map=render_map_initially(),markerLayer,geojsonLayer,markers=[],saved_data=[],current_data=[];obtain_initial_map_population(),ko.observableArray.fn.removeValueAtIndex=function(e){this.valueWillMutate(),this().splice(e,1),this.valueHasMutated()},ko.observableArray.fn.changeValueAtIndex=function(e,a){this.valueWillMutate(),this()[e]=a,this.valueHasMutated()};var vm=new all_experiments;ko.applyBindings(vm);