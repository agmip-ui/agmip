function make_default_when_undefined(b,a){if(typeof b==="undefined"){return a}return b}function build_current_data(g){var b;var a;var j;var m;var d;var c;var k;var e;var l;var h="N/A";vm.current_data([]);for(var f=0;f<g.length;f++){b=make_default_when_undefined(g[f]["eid"],h);a=make_default_when_undefined(g[f]["crid"],h);j=make_default_when_undefined(g[f]["pdate"],h);m=make_default_when_undefined(g[f]["soil"],h);d=make_default_when_undefined(g[f]["institution"],h);c=make_default_when_undefined(g[f]["country"],h);k=make_default_when_undefined(g[f]["exname"],h);e=make_default_when_undefined(g[f]["rating"],"unrated");if(vm.findIndex(b,vm.saved_data())===-1){l=false}else{l=true}vm.current_data.push(new experiment(b,a,j,m,d,c,k,e,l))}vm.showHideCurrentDataTable()}$("#obtain_data").click(function(){var d=$("#crop_filter").val();var f=[];var b=map.getBounds();var e=0;var a;for(var c=0;c<markers.length;c++){a=markers[c];if(b.contains([parseFloat(a._latlng["lat"]),parseFloat(a._latlng["lng"])])){f.push(a.options["geohash"]);e=e+parseFloat(a.options["count"])}}retrieve_data(d,f,e)});$("#map").on("click",".obtain_data_from_cluster_or_marker",function(a){var c=$(this).data("geohashes");var b=$(this).data("eid_count");map.closePopup();retrieve_data("none",c,b)});$("#map").on("place_markers_and_clusters_on_map",function(b,a){if(a.location_data.length>0){markers=[];place_markers_and_clusters_on_map(a.location_data)}});$("#map").on("build_current_data",function(b,a){build_current_data(a.data)});$("#map").on("prompt_user_for_download",function(b,a){window.open(a.url,"","width=200,height=100")});$("#apply_filter").click(function(){map.closePopup();var a=$("#crop_filter").val();obtain_specific_crop_map_population(a)});$("#download_data").click(function(){if(vm.saved_data().length>0){var c=[];var a=$(".db_type_filter");var b=[];$(a).each(function(d){if($(a[d]).prop("checked")){c.push($(a[d]).val())}});b=vm.extractEids(vm.saved_data());retrieve_database(c,b)}});function enable_disable_download_button(){var a=false;$(".db_type_filter").each(function(b,c){if($(c).prop("checked")){$("#download_data").prop("disabled",false);a=true;return false}});if(a===false){$("#download_data").prop("disabled",true)}}$(".db_type_filter").click(function(){enable_disable_download_button()});$("#raise_up_download_modal").click(function(){$(".db_type_filter").each(function(a,b){$(b).prop("checked",false);$("#download_data").prop("disabled",true)})});$(".modal").on("show.bs.modal",function(){$("body").css("overflow-y","hidden");$(this).css("overflow-y","hidden")});$(".modal").on("hide.bs.modal",function(){$("body").css("overflow-y","auto");$(this).css("overflow-y","auto")});var api_url="http://199.231.188.53:60000/api/";function obtain_initial_map_population(){$("#spinner").modal("show");options={type:"GET",url:api_url,data:{populate:"True"},cache:true,dataType:"json"};$.ajax(options).done(function(a){$("#map").trigger("place_markers_and_clusters_on_map",{location_data:a})}).fail(function(){$("#error_message").text("Error: Failed To Populate Map");$("#alertModal").modal("show")}).always(function(){$("#spinner").modal("hide")})}function obtain_specific_crop_map_population(a){$("#spinner").modal("show");options={type:"GET",url:api_url,data:{crop_type:a},cache:true,dataType:"json"};$.ajax(options).done(function(b){$("#map").trigger("place_markers_and_clusters_on_map",{location_data:b})}).fail(function(){$("#error_message").text("Error: Search Operation Has Failed");$("#alertModal").modal("show")}).always(function(){$("#spinner").modal("hide")})}function retrieve_data(a,c,b){max_eids=50;if(b>max_eids){$("#error_message").html("Data Size Is Too Large. More Than Data Points "+max_eids+" Selected. <br>Please Specify Data By Using Filter Or By Zooming In.");$("#alertModal").modal("show")}else{$("#spinner").modal("show");c=JSON.stringify(c);options={type:"POST",url:api_url,data:{crop_type:a,geohashes:c},cache:true,dataType:"json"};$.ajax(options).done(function(d){$("#map").trigger("build_current_data",{data:d})}).fail(function(){$("#error_message").text("Error: Failed to Obtain Data");$("#alertModal").modal("show")}).always(function(){$("#spinner").modal("hide");vm.selectedAllChecked(false)})}}function retrieve_database(b,a){$("#spinner").modal("show");a=JSON.stringify(a);b=JSON.stringify(b);options={type:"POST",url:api_url,data:{database_types:b,eids:a},cache:true,dataType:"json"};$.ajax(options).done(function(c){$("#map").trigger("prompt_user_for_download",c)}).fail(function(){$("#error_message").text("Error: Failed to Download Database");$("#alertModal").modal("show")}).always(function(){$("#spinner").modal("hide")})}var map=render_map_initially();var markerLayer;var markers=[];var saved_data=[];var current_data=[];obtain_initial_map_population();function render_map_initially(){var b=L.tileLayer("http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpeg",{attribution:"",subdomains:"1234"});var a=L.map("map",{maxZoom:13,minZoom:2,maxBounds:[[-90,-180],[90,180]]}).setView([15,0],1);b.addTo(a);a.on("zoomend",function(){map.closePopup()});return a}function raise_marker_popup(b,a,d,c,e){c.setLatLng(b).openOn(e).setContent("<b style='color:#bb382b;'>Geohash Point</b> <br><button type='button' data-geohashes='"+JSON.stringify([a])+"' data-eid_count='"+d+"'class='btn btn-primary borRad obtain_data_from_cluster_or_marker' >Obtain Data</button> <br>has "+d+" experiments")}function create_markers_for_map(c){var a;var f;var b;var g;var e=L.popup({offset:L.point(0,-32)});for(var d=0;d<c.length;d++){g=c[d];a=parseFloat(g.lat);f=parseFloat(g.lng);b=L.marker([a,f],{geohash:g.geohash,count:g.count});b.on("contextmenu",function(h){raise_marker_popup(h.latlng,this.options.geohash,this.options.count,e,map)});markers.push(b)}if(markerLayer){map.removeLayer(markerLayer)}}function raise_cluster_popup(a,c,e,b,d){b.setLatLng(a).openOn(d).setContent("<b class='blueTxt'>Cluster of Geohashes</b><br><button type='button' data-geohashes='"+JSON.stringify(c)+"' data-eid_count='"+e+"' class='btn btn-primary borRad obtain_data_from_cluster_or_marker'>Obtain Data</button> <br> has "+e+" experiments")}function create_clusters_for_map(){markerLayer=new L.MarkerClusterGroup();markerLayer.addLayers(markers);var a=L.popup({offset:L.point(0,-10)});markerLayer.on("clustercontextmenu",function(d){var f=d.layer.getAllChildMarkers();var b=[];var e=0;for(var c=0;c<f.length;c++){b.push(f[c].options.geohash);e=e+parseFloat(f[c].options.count)}raise_cluster_popup(d.latlng,b,e,a,map)})}function place_markers_and_clusters_on_map(a){create_markers_for_map(a);create_clusters_for_map();map.addLayer(markerLayer)}ko.observableArray.fn.removeValueAtIndex=function(a){this.valueWillMutate();this().splice(a,1);this.valueHasMutated()};ko.observableArray.fn.changeValueAtIndex=function(a,b){this.valueWillMutate();this()[a]=b;this.valueHasMutated()};function experiment(b,a,f,j,d,c,g,e,h){var k=this;k.eid=b;k.crid=a;k.pdate=f;k.soil=j;k.institution=d;k.country=c;k.exname=g;k.rating=e;k.checked=ko.observable(h)}function all_experiments(){var a=this;a.current_data=ko.observableArray([]);a.saved_data=ko.observableArray([]);a.selected_all_checked=ko.observable(false);a.updateCheckMark=function(b,c){a.current_data()[b].checked(c)};a.toggleCheckMark=function(b){a.current_data()[b].checked(!a.current_data()[b].checked())};a.selectAllCheckMarks=function(){for(var b=0;b<a.current_data().length;b++){current_data_eid=a.current_data()[b]["eid"];index=a.findIndex(current_data_eid,a.saved_data());a.updateCheckMark(b,true);if(index===-1){a.saved_data.push(a.current_data()[b])}}};a.deselectAndRemoveSubsetCheckMarks=function(){for(i=0;i<a.current_data().length;i++){a.updateCheckMark(i,false);current_data_eid=a.current_data()[i]["eid"];saved_data_index=a.findIndex(current_data_eid,a.saved_data());if(saved_data_index!==-1){a.saved_data.removeValueAtIndex(saved_data_index)}}};a.deselectAllCheckMarks=function(){for(i=0;i<a.current_data().length;i++){a.updateCheckMark(i,false)}};a.removeAllCurrentData=function(){$("#clear_current_data").css("display","none");$("#current_data_number").hide();$("#current_data").hide();a.current_data([]);a.showHideCurrentDataTable()};a.clearSavedData=function(){a.saved_data([]);a.deselectAllCheckMarks();a.showHideSavedDataTable()};a.selectAllCurrentDataClicked=function(c,b){if(a.selected_all_checked()){a.selected_all_checked(false);a.deselectAndRemoveSubsetCheckMarks();a.showHideSavedDataTable()}else{a.selected_all_checked(true);a.selectAllCheckMarks();a.showHideSavedDataTable();$("html, body").animate({scrollTop:$("#saved_data_container").offset().top},1200)}return true};a.selectorClicked=function(b,c){saved_data_index=a.findIndex(b.eid,a.saved_data());current_data_index=a.findIndex(b.eid,a.current_data());a.toggleCheckMark(current_data_index);if(saved_data_index===-1){datum=a.current_data()[current_data_index];a.saved_data.push(datum)}else{a.saved_data.removeValueAtIndex(saved_data_index)}a.showHideSavedDataTable();return true};a.removerClicked=function(b){saved_data_index=a.findIndex(b.eid,a.saved_data());a.saved_data.removeValueAtIndex(saved_data_index);current_data_index=a.findIndex(b.eid,a.current_data());a.toggleCheckMark(current_data_index);a.showHideSavedDataTable();return true};a.showHideCurrentDataTable=function(){if(a.current_data().length>0){$("#current_data").show();$("#clear_current_data").show();$("#current_data_number").show();$("#current_data_number").find("b").text(a.current_data().length);var b=$("a[data-target='#current_data_container']");if(b.hasClass("collapsed")){b.removeClass("collapsed");$("#current_data_container").collapse("toggle")}$("html, body").animate({scrollTop:$("#current_data_container").offset().top},1200)}else{a.selected_all_checked(false)}};a.showHideSavedDataTable=function(){if(a.saved_data().length>0){$("#saved_data").show();$(".saved_data_button").show();var b=$("a[data-target='#saved_data_container']");if(b.hasClass("collapsed")){b.removeClass("collapsed");$("#saved_data_container").collapse("toggle")}$("#saved_data_number").show();$("#saved_data_number").text(a.saved_data().length)}else{$("#saved_data").hide();$(".saved_data_button").hide();$("#saved_data_number").hide();a.selected_all_checked(false)}};a.findIndex=function(b,d){for(var c=0;c<d.length;c++){if(b===d[c]["eid"]){return c}}return -1};a.extractEids=function(c){var b=[];for(i=0;i<c.length;i++){b.push(c[i]["eid"])}return b}}var vm=new all_experiments();ko.applyBindings(vm);